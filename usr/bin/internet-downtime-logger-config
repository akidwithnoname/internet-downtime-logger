#!/bin/bash

CONFIG_FILE="./.config/internet-downtime-logger/internet-downtime-logger.conf"
USER=$(id -u)
if [ $USER = 0 ]
then
    echo "please do not run Internet Downtime Logger as root!"
    echo "exiting in 5 seconds"
    sleep 5
    exit 0
fi
cd
if [ -e "$CONFIG_FILE" ]
    then
        echo "using existing config file"
    else
        echo "creating new config file"
        mkdir "./.config/internet-downtime-logger"
        cp -r "/usr/share/internet-downtime-logger/internet-downtime-logger.conf" "$CONFIG_FILE"
        if [ -e "$CONFIG_FILE" ]
        then 
            echo "config file created succesfully"
        else
            echo "unable to create config file"
            echo "exiting in 5 seconds"
            sleep 5
            exit 0
        fi
fi

echo "reading config file"
source "$CONFIG_FILE"

#---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

# INITIAL SETUP {

    sed -n "2,24p" "/usr/bin/internet-downtime-logger"
    echo "This is the initial setup process for Internet Downtime Logger."
    echo ""
    echo "How do you wish to set up Internet Downtime Logger?"
    echo "( 0 = guided setup | 1 = manually edit config file )"
    read SETUP_TYPE
    if [ "$SETUP_TYPE" = "1" ]
    then
        nano "$CONFIG_FILE"
        echo ""
        echo ""
        echo "Initial setup complete. To reconfigure settings use 'internet-downtime-logger-config' command"
        echo ""
        echo 'Start Internet Downtime Logger again using the command "internet-downtime-logger"'
        sed -i 's|INITIAL_SETUP=".*"|INITIAL_SETUP="'"0"'"|g' "$CONFIG_FILE"
        echo "exiting in 5 seconds"
        sleep 5
        exit 0
    else
        echo "Starting guided setup"
    fi

# DATE / TIME FORMAT SETUP

    echo ""
    echo ""
    echo "Would you like to reconfigure date/time formats?"
    echo "Date/time formats can be anything suported by "date" command."
    echo "See <http://man7.org/linux/man-pages/man1/date.1.html> for more information about formatting dates."
    echo ""
    echo "Current Date Formats:"
    echo ""
    HUMAN_DATE_FORMAT1=$(date +"$HUMAN_DATE_FORMAT")
    HUMAN_DAY_FORMAT1=$(date +"$HUMAN_DAY_FORMAT")
    HUMAN_MONTH_FORMAT1=$(date +"$HUMAN_MONTH_FORMAT")
    echo "CODE"
    echo "Instant Date Format = $HUMAN_DATE_FORMAT"
    echo "Daily Total Date Format = $HUMAN_DAY_FORMAT"
    echo "Monthly Total Date Format = $HUMAN_MONTH_FORMAT"
    echo ""
    echo "RESULTS"
    echo "Instant Date Format = $HUMAN_DATE_FORMAT1"
    echo "Daily Total Date Format = $HUMAN_DAY_FORMAT1"
    echo "Monthly Total Date Format = $HUMAN_MONTH_FORMAT1"
    echo ""
    echo "Type desired option and press enter"
    echo "( 0 = keep current | 1 = configure | 2 = reset defaults )"
    read DATETIME_SETUP
    if [ "$DATETIME_SETUP" = "1" ]
    then
        while true; do 
            echo ""
            echo "Please enter the desired format for Instant Downtime Logs and Notifications."
            echo "default = %D (%A %B %d %Y) %r"
            read SET_INSTANT_FORMAT
            echo ""
            echo "Using $SET_INSTANT_FORMAT"
            echo "Is the following output correct?"
            echo "( 1 = Yes | 0 = No )"
            date +"$SET_INSTANT_FORMAT"
            read SET_INSTANT_FORMAT_QUESTION
            if [ "$SET_INSTANT_FORMAT_QUESTION" = "1" ]
            then
                break
            else
                continue
            fi
        done
        sed -i 's|HUMAN_DATE_FORMAT=".*"|HUMAN_DATE_FORMAT="'"${SET_INSTANT_FORMAT}"'"|g' "$CONFIG_FILE"
        while true; do
            echo ""
            echo "Please enter the desired format for Daily Downtime Logs and Notifications."
            echo "default = %D (%A %B %d %Y)"
            read SET_DAILY_FORMAT
            echo ""
            echo "Using $SET_DAILY_FORMAT"
            echo "Is the following output correct?"
            echo "( 1 = Yes | 0 + No )"
            date +"$SET_DAILY_FORMAT"
            read SET_DAILY_FORMAT_QUESTION
            if [ "$SET_DAILY_FORMAT_QUESTION" = "1" ]
            then
                break
            else
                continue
            fi
        done
        sed -i 's|HUMAN_DAY_FORMAT=".*"|HUMAN_DAY_FORMAT="'"${SET_DAILY_FORMAT}"'"|g' "$CONFIG_FILE"
        while true; do 
            echo ""
            echo "Please enter the desired format for Monthly Downtime Logs and Notifications."
            echo "default = %B %Y"
            read SET_MONTHLY_FORMAT
            echo ""
            echo "Using $SET_MONTHLY_FORMAT"
            echo "Is the following output correct?"
            echo "( 1 = Yes | 0 + No )"
            date +"$SET_MONTHLY_FORMAT"
            read SET_MONTHLY_FORMAT_QUESTION
            if [ "$SET_MONTHLY_FORMAT_QUESTION" = "1" ]
            then
                break
            else
                continue
            fi
        done
        sed -i 's|HUMAN_MONTH_FORMAT=".*"|HUMAN_MONTH_FORMAT="'"${SET_MONTHLY_FORMAT}"'"|g' "$CONFIG_FILE"
        echo ""
    else
        if [ "$DATETIME_SETUP" = "2" ]
        then
            sed -i 's|HUMAN_MONTH_FORMAT=".*"|HUMAN_MONTH_FORMAT="'"%B %Y"'"|g' "$CONFIG_FILE"
            sed -i 's|HUMAN_DAY_FORMAT=".*"|HUMAN_DAY_FORMAT="'"%D (%A %B %d %Y)"'"|g' "$CONFIG_FILE"
            sed -i 's|HUMAN_DATE_FORMAT=".*"|HUMAN_DATE_FORMAT="'"%D (%A %B %d %Y) %r"'"|g' "$CONFIG_FILE"
        fi
    fi

# EMAIL SETUP

    echo ""
    echo ""
    echo "How would you like to configure Internet Downtime Logger's email notification system?"
    echo ""
    echo "Current Settings:"
    echo ""
    echo "From email adress = $FROM_EMAIL"
    echo "From email SMTP server = $SMTP_SERVER"
    echo "From email SMTP server port = $SMTP_PORT"
    echo ""
    echo "Instant notifications = $NOTIFICATION"
    echo "Instant notifications to email = $TO_EMAIL"
    echo "Instant notifications subject = $EMAIL_SUBJECT"
    echo ""
    echo "Daily total notifications = $NOTIFICATION_TOTAL_DAILY"
    echo "Daily total notifications to email = $TO_EMAIL_DAILY"
    echo "Daily total notifications subject = $EMAIL_SUBJECT_DAILY"
    echo ""
    echo "Monthly total notifications = $NOTIFICATION_TOTAL_MONTHLY"
    echo "Monthly total notifications to email = $TO_EMAIL_MONTHLY"
    echo "Monthly total notifications subject = $EMAIL_SUBJECT_MONTHLY"
    echo ""
    echo "Type desired option and press enter"
    echo "( 0 = keep current | 1 = configure | 2 = dissable )"
    read EMAIL_SETUP
    if [ "$EMAIL_SETUP" = "1" ]
    then
        echo ""
        echo "Please enter the email address Internet Downtime Logger will send notifications from"
        echo "example = emailaddress@site.com"
        read SET_FROM_EMAIL
        echo ""
        echo "Using $SET_FROM_EMAIL"
        sed -i 's|FROM_EMAIL=".*"|FROM_EMAIL="'"${SET_FROM_EMAIL}"'"|g' "$CONFIG_FILE"
        echo ""
        echo "Please enter the password for $SET_FROM_EMAIL"
        echo "example = pa55w0RD"
        read SET_FROM_PASSWORD
        echo ""
        echo "Using $SET_FROM_PASSWORD"
        sed -i 's|FROM_EMAIL_PASSWORD=".*"|FROM_EMAIL_PASSWORD="'"${SET_FROM_PASSWORD}"'"|g' "$CONFIG_FILE"
        echo ""
        echo "Please enter the SMTP server for your email provider"
        echo "example = smtp://smtp.site.com"
        read SET_SMTP_SERVER
        echo ""
        echo "Using $SET_SMTP_SERVER"
        sed -i 's|SMTP_SERVER=".*"|SMTP_SERVER="'"${SET_SMTP_SERVER}"'"|g' "$CONFIG_FILE"
        echo ""
        echo "Please enter the SMTP port for your email provider's SMTP server"
        echo "example = 587"
        read SET_SMTP_PORT
        echo ""
        echo "Using $SET_SMTP_PORT"
        sed -i 's|SMTP_PORT=".*"|SMTP_PORT="'"${SET_SMTP_PORT}"'"|g' "$CONFIG_FILE"
        echo ""
        echo "Would you like to enable instant downtime email notifications?"
        echo "Type desired option and press enter."
        echo "( 0 = dissabled | 1 = enabled | 2 = enabled with attached log )"
        read SETNOTIFICATION
        if [ "$SETNOTIFICATION" = "1" ] || [ "$SETNOTIFICATION" = "2" ]
        then
            echo ""
            echo "Setting instant notifications to $SETNOTIFICATION"
            sed -i 's|NOTIFICATION=".*"|NOTIFICATION="'"${SETNOTIFICATION}"'"|g' "$CONFIG_FILE"
            echo ""
            echo "Please enter the email address you would like to send instant downtime notifications to."
            echo "Seperate with , and no spaces to add multiple."
            read INSTANT_NOTIFICATION_TO
            echo ""
            echo "Will send instant emails to $INSTANT_NOTIFICATION_TO"
            sed -i 's|TO_EMAIL=".*"|TO_EMAIL="'"${INSTANT_NOTIFICATION_TO}"'"|g' "$CONFIG_FILE"
            echo ""
            echo "Would you like to set a custom subject for instant downtime email notifications?"
            echo "Default = Internet Downtime Notification"
            echo "( 0 = no | 1 = yes )"
            read INSTANT_EMAIL_CUSTOM_SUBJECT_QUESTION
            if [ "$INSTANT_EMAIL_CUSTOM_SUBJECT_QUESTION" = "1" ]
            then
                echo ""
                echo "Please enter the desired subject for instant downtime email notifications."
                read INSTANT_EMAIL_CUSTOM_SUBJECT
                echo ""
                echo "Using $INSTANT_EMAIL_CUSTOM_SUBJECT"
                sed -i 's|EMAIL_SUBJECT=".*"|EMAIL_SUBJECT="'"${INSTANT_EMAIL_CUSTOM_SUBJECT}"'"|g' "$CONFIG_FILE"
            fi
        else
            echo ""
            echo "Setting instant notifications to $SETNOTIFICATION"
            sed -i 's|NOTIFICATION=".*"|NOTIFICATION="'"${SETNOTIFICATION}"'"|g' "$CONFIG_FILE"
        fi
        echo ""
        echo "Would you like to enable daily total downtime email notifications?"
        echo "Type desired option and press enter"
        echo "( 0 = dissabled | 1 = enabled | 2 = enabled with attached log )"
        read SETNOTIFICATION_DAILY
        if [ "$SETNOTIFICATION_DAILY" = "1" ] || [ "$SETNOTIFICATION_DAILY" = "2" ]
        then
            echo ""
            echo "Setting daily total downtime notifications to $SETNOTIFICATION_DAILY"
            sed -i 's|NOTIFICATION_TOTAL_DAILY=".*"|NOTIFICATION_TOTAL_DAILY="'"${SETNOTIFICATION_DAILY}"'"|g' "$CONFIG_FILE"
            echo ""
            echo "Please enter the email address you would like to send daily downtime notifications to."
            echo "Seperate with , and no spaces to add multiple."
            read DAILY_NOTIFICATION_TO
            echo ""
            echo "Will send daily emails to $DAILY_NOTIFICATION_TO"
            sed -i 's|TO_EMAIL_DAILY=".*"|TO_EMAIL_DAILY="'"${DAILY_NOTIFICATION_TO}"'"|g' "$CONFIG_FILE"
            echo ""
            echo "Would you like to set a custom subject for daily total downtime email notifications?"
            echo "Default = Daily Internet Downtime Total"
            echo "( 0 = no | 1 = yes )"
            read DAILY_EMAIL_CUSTOM_SUBJECT_QUESTION
            if [ "$DAILY_EMAIL_CUSTOM_SUBJECT_QUESTION" = "1" ]
            then
                echo ""
                echo "Please enter the desired subject for daily total downtime email notifications."
                read DAILY_EMAIL_CUSTOM_SUBJECT
                echo ""
                echo "Using $DAILY_EMAIL_CUSTOM_SUBJECT"
                sed -i 's|EMAIL_SUBJECT_DAILY=".*"|EMAIL_SUBJECT_DAILY="'"${DAILY_EMAIL_CUSTOM_SUBJECT}"'"|g' "$CONFIG_FILE"
            fi
        else
            echo ""
            echo "Setting daily total downtime notifications to $SETNOTIFICATION_DAILY"
            sed -i 's|NOTIFICATION_TOTAL_DAILY=".*"|NOTIFICATION_TOTAL_DAILY="'"${SETNOTIFICATION_DAILY}"'"|g' "$CONFIG_FILE"
        fi
        echo ""
        echo "Would you like to enable monthly total downtime email notifications?"
        echo "Type desired option and press enter."
        echo "( 0 = dissabled | 1 = enabled | 2 = enabled with attached log )"
        read SETNOTIFICATION_MONTHLY
        if [ "$SETNOTIFICATION_MONTHLY" = "1" ] || [ "$SETNOTIFICATION_MONTHLY" = "2" ]
        then
            echo ""
            echo "Setting monthly total downtime notifications to $SETNOTIFICATION_MONTHLY"
            sed -i 's|NOTIFICATION_TOTAL_MONTHLY=".*"|NOTIFICATION_TOTAL_MONTHLY="'"${SETNOTIFICATION_MONTHLY}"'"|g' "$CONFIG_FILE"
            echo ""
            echo "Please enter the email address you would like to send monthly downtime notifications to."
            echo "Seperate with , and no spaces to add multiple."
            read MONTHLY_NOTIFICATION_TO
            echo ""
            echo "Will send monthly emails to $MONTHLY_NOTIFICATION_TO"
            sed -i 's|TO_EMAIL_MONTHLY=".*"|TO_EMAIL_MONTHLY="'"${MONTHLY_NOTIFICATION_TO}"'"|g' "$CONFIG_FILE"
            echo ""
            echo "Would you like to set a custom subject for monthly total downtime email notifications?"
            echo "Default = Monthly Internet Downtime Total"
            echo "( 0 = no | 1 = yes )"
            read MONTHLY_EMAIL_CUSTOM_SUBJECT_QUESTION
            if [ "$MONTHLY_EMAIL_CUSTOM_SUBJECT_QUESTION" = "1" ]
            then
                echo ""
                echo "Please enter the desired subject for monthly total downtime email notifications."
                read MONTHLY_EMAIL_CUSTOM_SUBJECT
                echo ""
                echo "Using $MONTHLY_EMAIL_CUSTOM_SUBJECT"
                sed -i 's|EMAIL_SUBJECT_MONTHLY=".*"|EMAIL_SUBJECT_MONTHLY="'"${MONTHLY_EMAIL_CUSTOM_SUBJECT}"'"|g' "$CONFIG_FILE"
            fi
        else
            echo ""
            echo "Setting monthly total downtime notifications to $SETNOTIFICATION_MONTHLY"
            sed -i 's|NOTIFICATION_TOTAL_MONTHLY=".*"|NOTIFICATION_TOTAL_MONTHLY="'"${SETNOTIFICATION_MONTHLY}"'"|g' "$CONFIG_FILE"
        fi
    else
        if [ "$EMAIL_SETUP" = "2" ]
        then
            sed -i 's|NOTIFICATION=".*"|NOTIFICATION="'"0"'"|g' "$CONFIG_FILE"
            sed -i 's|NOTIFICATION_TOTAL_DAILY=".*"|NOTIFICATION_TOTAL_DAILY="'"0"'"|g' "$CONFIG_FILE"
            sed -i 's|NOTIFICATION_TOTAL_MONTHLY=".*"|NOTIFICATION_TOTAL_MONTHLY="'"0"'"|g' "$CONFIG_FILE"
        fi
    fi

# SERVER SETUP

    echo ""
    echo ""
    echo "Would you like to reconfigure the current server settings?"
    echo ""
    echo "Current Settings:"
    echo ""
    echo "Server 1 IP address   = $SERVER1"
    echo "Server 2 IP address   = $SERVER2"
    echo "Server 3 IP address   = $SERVER3"
    echo "Server 4 IP address   = $SERVER4"
    echo "Ping primary server every...                         = $SLEEP_TIME1"
    echo "Ping other servers if primary fails every...         = $SLEEP_TIME2"
    echo "Ping servers after connection has been lost every... = $SLEEP_TIME_OFFLINE"
    echo ""
    echo "Type desired option and press enter"
    echo "( 0 = keep current | 1 = configure | 2 = reset defaults )"
    read SERVER_SETUP
    if [ "$SERVER_SETUP" = "1" ]
    then
        echo ""
        echo "Set server 1 (Primary)."
        echo "Enter a URL or IP."
        echo "Default = 8.8.8.8"
        read SET_SERVER1
        echo ""
        echo "Using $SET_SERVER1"
        sed -i 's|SERVER1=".*"|SERVER1="'"${SET_SERVER1}"'"|g' "$CONFIG_FILE"
        echo ""
        echo "Set server 2."
        echo "Enter a URL or IP."
        echo "Default = 4.2.2.2"
        read SET_SERVER2
        echo ""
        echo "Using $SET_SERVER2"
        sed -i 's|SERVER2=".*"|SERVER2="'"${SET_SERVER2}"'"|g' "$CONFIG_FILE"
        echo ""
        echo "Set server 3."
        echo "Enter a URL or IP."
        echo "Default = 8.8.4.4"
        read SET_SERVER3
        echo ""
        echo "Using $SET_SERVER3"
        sed -i 's|SERVER3=".*"|SERVER3="'"${SET_SERVER3}"'"|g' "$CONFIG_FILE"
        echo ""
        echo "Set server 4."
        echo "Enter a URL or IP."
        echo "Default = 4.2.2.1"
        read SET_SERVER4
        echo ""
        echo "Using $SET_SERVER4"
        sed -i 's|SERVER4=".*"|SERVER4="'"${SET_SERVER4}"'"|g' "$CONFIG_FILE"
        echo ""
        echo "Set amount of time between each ping request to primary server."
        echo "Enter time value in seconds."
        echo "Default = 7"
        read SET_SLEEP_TIME1
        echo ""
        echo "Using $SET_SLEEP_TIME1"
        sed -i 's|SLEEP_TIME1=".*"|SLEEP_TIME1="'"${SET_SLEEP_TIME1}"'"|g' "$CONFIG_FILE"
        echo ""
        echo "Set amount of time between pinging other servers if primary is unavailable."
        echo "Enter time value in seconds."
        echo "Default = 15"
        read SET_SLEEP_TIME2
        echo ""
        echo "Using $SET_SLEEP_TIME2"
        sed -i 's|SLEEP_TIME2=".*"|SLEEP_TIME2="'"${SET_SLEEP_TIME2}"'"|g' "$CONFIG_FILE"
        echo ""
        echo "Set amount of time between each ping request to servers after connection has been lost."
        echo "Enter time value in seconds."
        echo "Default = 10"
        read SET_SLEEP_TIME_OFFLINE
        echo ""
        echo "Using $SET_SLEEP_TIME_OFFLINE"
        sed -i 's|SLEEP_TIME_OFFLINE=".*"|SLEEP_TIME_OFFLINE="'"${SET_SLEEP_TIME_OFFLINE}"'"|g' "$CONFIG_FILE"
    else
         if [ "$SERVER_SETUP" = "2" ]
         then
             sed -i 's|SERVER1=".*"|SERVER1="'"8.8.8.8"'"|g' "$CONFIG_FILE"
             sed -i 's|SERVER2=".*"|SERVER2="'"4.2.2.2"'"|g' "$CONFIG_FILE"
             sed -i 's|SERVER3=".*"|SERVER3="'"8.8.4.4"'"|g' "$CONFIG_FILE"
             sed -i 's|SERVER4=".*"|SERVER4="'"4.2.2.1"'"|g' "$CONFIG_FILE"
             sed -i 's|SLEEP_TIME1=".*"|SLEEP_TIME1="'"5"'"|g' "$CONFIG_FILE"
             sed -i 's|SLEEP_TIME2=".*"|SLEEP_TIME2="'"15"'"|g' "$CONFIG_FILE"
             sed -i 's|SLEEP_TIME_OFFLINE=".*"|SLEEP_TIME_OFFLINE="'"10"'"|g' "$CONFIG_FILE"
             fi
    fi

# LOG FILE SETUP

    echo ""
    echo ""
    echo "Would you like to change the log file location?"
    echo "Current = $LOG_SAVE_LOCATION"
    echo ""
    echo "( 0 = keep current | 1 = change )"
    read LOGFILE_SETUP
    if [ "$LOGFILE_SETUP" = "1" ]
    then
        echo ""
        echo "Please enter the path to the file you wish to save the log to"
        echo "Default = ./internet downtime log.txt"
        read SET_LOG_SAVE_LOCATION
         sed -i 's|LOG_SAVE_LOCATION=".*"|LOG_SAVE_LOCATION="'"${SET_LOG_SAVE_LOCATION}"'"|g' "$CONFIG_FILE"
    fi

# INITIAL SETUP

echo ""
echo ""
echo "Initial setup complete. To reconfigure settings use 'internet-downtime-logger-config' command"
echo ""
echo 'Start Internet Downtime Logger again using the command "internet-downtime-logger"'
sed -i 's|INITIAL_SETUP=".*"|INITIAL_SETUP="'"0"'"|g' "$CONFIG_FILE"
echo "exiting in 5 seconds"
sleep 5
exit 0
